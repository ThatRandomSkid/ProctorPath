import{g as V,h as D,S as H,C as p,i as u,V as n}from"./index-mnTSl45J.js";class P{constructor(e,i,w,c){this.name=e,this.worldAxisForNormal=i,this.worldAxisForFileX=w,this.worldAxisForFileY=c}}class _{static ConvertCubeMapTextureToSphericalPolynomial(e){if(!e.isCube)return null;e.getScene()?.getEngine().flushFramebuffer();const i=e.getSize().width,w=e.readPixels(0,void 0,void 0,!1),c=e.readPixels(1,void 0,void 0,!1);let A,a;e.isRenderTarget?(A=e.readPixels(3,void 0,void 0,!1),a=e.readPixels(2,void 0,void 0,!1)):(A=e.readPixels(2,void 0,void 0,!1),a=e.readPixels(3,void 0,void 0,!1));const C=e.readPixels(4,void 0,void 0,!1),T=e.readPixels(5,void 0,void 0,!1),R=e.gammaSpace,x=5;let E=0;return(e.textureType==1||e.textureType==2)&&(E=1),new Promise(S=>{Promise.all([c,w,A,a,C,T]).then(([h,F,r,t,f,d])=>{const m={size:i,right:F,left:h,up:r,down:t,front:f,back:d,format:x,type:E,gammaSpace:R};S(this.ConvertCubeMapToSphericalPolynomial(m))})})}static _AreaElement(e,i){return Math.atan2(e*i,Math.sqrt(e*e+i*i+1))}static ConvertCubeMapToSphericalPolynomial(e){const i=new V;let w=0;const c=2/e.size,A=c,a=.5*c,C=a-1;for(let S=0;S<6;S++){const h=this._FileFaces[S],F=e[h.name];let r=C;const t=e.format===5?4:3;for(let f=0;f<e.size;f++){let d=C;for(let m=0;m<e.size;m++){const y=h.worldAxisForFileX.scale(d).add(h.worldAxisForFileY.scale(r)).add(h.worldAxisForNormal);y.normalize();const z=this._AreaElement(d-a,r-a)-this._AreaElement(d-a,r+a)-this._AreaElement(d+a,r-a)+this._AreaElement(d+a,r+a);let s=F[f*e.size*t+m*t+0],o=F[f*e.size*t+m*t+1],l=F[f*e.size*t+m*t+2];isNaN(s)&&(s=0),isNaN(o)&&(o=0),isNaN(l)&&(l=0),e.type===0&&(s/=255,o/=255,l/=255),e.gammaSpace&&(s=Math.pow(p(s),u),o=Math.pow(p(o),u),l=Math.pow(p(l),u));const g=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){const L=Math.max(s,o,l);if(L>g){const M=g/L;s*=M,o*=M,l*=M}}else s=p(s,0,g),o=p(o,0,g),l=p(l,0,g);const v=new D(s,o,l);i.addLight(y,v,z),w+=z,d+=c}r+=A}}const E=4*Math.PI*6/6/w;return i.scaleInPlace(E),i.convertIncidentRadianceToIrradiance(),i.convertIrradianceToLambertianRadiance(),H.FromHarmonics(i)}}_._FileFaces=[new P("right",new n(1,0,0),new n(0,0,-1),new n(0,-1,0)),new P("left",new n(-1,0,0),new n(0,0,1),new n(0,-1,0)),new P("up",new n(0,1,0),new n(1,0,0),new n(0,0,1)),new P("down",new n(0,-1,0),new n(1,0,0),new n(0,0,-1)),new P("front",new n(0,0,1),new n(1,0,0),new n(0,-1,0)),new P("back",new n(0,0,-1),new n(-1,0,0),new n(0,-1,0))];_.MAX_HDRI_VALUE=4096;_.PRESERVE_CLAMPED_COLORS=!1;export{_ as C};
